Panic in agent.Run: sqlite3: out of memory

Time: 2025-06-15T17:20:54-05:00

Stack Trace:
goroutine 1410 [running]:
runtime/debug.Stack()
	/home/runner/go/pkg/mod/golang.org/toolchain@v0.0.1-go1.24.0.linux-amd64/src/runtime/debug/stack.go:26 +0x5e
github.com/opencode-ai/opencode/internal/logging.RecoverPanic({0x19ebea4, 0x9}, 0xc001907f58)
	/home/runner/work/opencode/opencode/internal/logging/logger.go:68 +0x325
panic({0x16ce640?, 0x1ff7f40?})
	/home/runner/go/pkg/mod/golang.org/toolchain@v0.0.1-go1.24.0.linux-amd64/src/runtime/panic.go:787 +0x132
github.com/ncruces/go-sqlite3.(*sqlite).error(0xc00339c708?, 0x19f6abe?, 0x0?, {0x0?, 0xc000bf2c90?, 0x0?})
	/home/runner/go/pkg/mod/github.com/ncruces/go-sqlite3@v0.25.0/sqlite.go:124 +0x2a5
github.com/ncruces/go-sqlite3.(*Conn).error(...)
	/home/runner/go/pkg/mod/github.com/ncruces/go-sqlite3@v0.25.0/conn.go:481
github.com/ncruces/go-sqlite3.(*Stmt).Reset(0xc00104a270)
	/home/runner/go/pkg/mod/github.com/ncruces/go-sqlite3@v0.25.0/stmt.go:88 +0x94
github.com/ncruces/go-sqlite3/driver.(*rows).Close(0xc00005c180)
	/home/runner/go/pkg/mod/github.com/ncruces/go-sqlite3@v0.25.0/driver/driver.go:651 +0x2e
database/sql.(*Rows).close.func1()
	/home/runner/go/pkg/mod/golang.org/toolchain@v0.0.1-go1.24.0.linux-amd64/src/database/sql/sql.go:3458 +0x29
database/sql.withLock({0x2007b10, 0xc00070e880}, 0xc000bf2df8)
	/home/runner/go/pkg/mod/golang.org/toolchain@v0.0.1-go1.24.0.linux-amd64/src/database/sql/sql.go:3574 +0x71
database/sql.(*Rows).close(0xc00135c3c0, {0x0, 0x0})
	/home/runner/go/pkg/mod/golang.org/toolchain@v0.0.1-go1.24.0.linux-amd64/src/database/sql/sql.go:3457 +0x13e
database/sql.(*Rows).Close(0xc00135c3c0)
	/home/runner/go/pkg/mod/golang.org/toolchain@v0.0.1-go1.24.0.linux-amd64/src/database/sql/sql.go:3441 +0x26
panic({0x16ce640?, 0x1ff7f40?})
	/home/runner/go/pkg/mod/golang.org/toolchain@v0.0.1-go1.24.0.linux-amd64/src/runtime/panic.go:787 +0x132
github.com/ncruces/go-sqlite3.(*sqlite).error(0xc00339c708?, 0x19f48c5?, 0x0?, {0x0?, 0xc000bf2fd8?, 0xb?})
	/home/runner/go/pkg/mod/github.com/ncruces/go-sqlite3@v0.25.0/sqlite.go:124 +0x2a5
github.com/ncruces/go-sqlite3.(*Conn).error(...)
	/home/runner/go/pkg/mod/github.com/ncruces/go-sqlite3@v0.25.0/conn.go:481
github.com/ncruces/go-sqlite3.(*Stmt).step(0xc00104a270)
	/home/runner/go/pkg/mod/github.com/ncruces/go-sqlite3@v0.25.0/stmt.go:125 +0xdb
github.com/ncruces/go-sqlite3.(*Stmt).Step(0xc00104a270)
	/home/runner/go/pkg/mod/github.com/ncruces/go-sqlite3@v0.25.0/stmt.go:113 +0x6b
github.com/ncruces/go-sqlite3/driver.(*rows).Next(0xc00005c180, {0xc00005d500, 0x8, 0x0?})
	/home/runner/go/pkg/mod/github.com/ncruces/go-sqlite3@v0.25.0/driver/driver.go:768 +0xd5
database/sql.(*Rows).nextLocked(0xc00135c3c0)
	/home/runner/go/pkg/mod/golang.org/toolchain@v0.0.1-go1.24.0.linux-amd64/src/database/sql/sql.go:3066 +0x102
database/sql.(*Rows).Next.func1()
	/home/runner/go/pkg/mod/golang.org/toolchain@v0.0.1-go1.24.0.linux-amd64/src/database/sql/sql.go:3041 +0x29
database/sql.withLock({0x2007388, 0xc00135c3f8}, 0xc000bf31a0)
	/home/runner/go/pkg/mod/golang.org/toolchain@v0.0.1-go1.24.0.linux-amd64/src/database/sql/sql.go:3574 +0x71
database/sql.(*Rows).Next(0xc00135c3c0)
	/home/runner/go/pkg/mod/golang.org/toolchain@v0.0.1-go1.24.0.linux-amd64/src/database/sql/sql.go:3040 +0x71
database/sql.(*Row).Scan(0xc0002fe0d8, {0xc001907298?, 0x2da2aa0?, 0x8})
	/home/runner/go/pkg/mod/golang.org/toolchain@v0.0.1-go1.24.0.linux-amd64/src/database/sql/sql.go:3511 +0x107
github.com/opencode-ai/opencode/internal/db.(*Queries).CreateMessage(0xc0001c8000, {0x2016800, 0x2da2aa0}, {{0xc000ac2060, 0x24}, {0xc000c83bc0, 0x1e}, {0x19dfa6e, 0x4}, {0xc030e14000, ...}, ...})
	/home/runner/work/opencode/opencode/internal/db/messages.sql.go:45 +0x2cd
github.com/opencode-ai/opencode/internal/message.(*service).Create(0xc0001dd8c0, {0x2016800, 0x2da2aa0}, {0xc000c83bc0, 0x1e}, {{0x19dfa6e, 0x4}, {0xc0004d0020, 0x2, 0x2}, ...})
	/home/runner/work/opencode/opencode/internal/message/message.go:67 +0x3a8
github.com/opencode-ai/opencode/internal/llm/agent.(*agent).streamAndHandleEvents(0xc00135d040, {0x2016870, 0xc000b5b310}, {0xc000117a80, 0x1e}, {0xc002caea08?, 0xc000117a80?, 0x1e?})
	/home/runner/work/opencode/opencode/internal/llm/agent/agent.go:414 +0x14cb
github.com/opencode-ai/opencode/internal/llm/agent.(*agent).processGeneration(0xc00135d040, {0x2016870, 0xc000b5b310}, {0xc000117a80, 0x1e}, {_, _}, {0x0, 0x0, 0x0})
	/home/runner/work/opencode/opencode/internal/llm/agent/agent.go:282 +0x885
github.com/opencode-ai/opencode/internal/llm/agent.(*agent).Run.func1()
	/home/runner/work/opencode/opencode/internal/llm/agent/agent.go:218 +0x3c8
created by github.com/opencode-ai/opencode/internal/llm/agent.(*agent).Run in goroutine 1269
	/home/runner/work/opencode/opencode/internal/llm/agent/agent.go:209 +0x2b6

